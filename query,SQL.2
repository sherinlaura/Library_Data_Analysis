WITH daily_stats AS (
    SELECT
        t.date,
        COUNT(DISTINCT t.id_transaction) AS transaction_count,
        AVG(t.amount) AS avg_spend,
        SUM(t.amount) AS total_revenue,
        w.temp,
        w.rain,
        CASE
            WHEN w.rain > (
                SELECT AVG(rain) FROM weather
            ) THEN 'Rainy Spike'
            ELSE 'Normal'
        END AS rain_flag
    FROM
        transactions t
        JOIN weather w ON CAST(t.date AS DATE) = CAST(w.date AS DATE)
    GROUP BY
        t.date, w.temp, w.rain
),
moving_avg AS (
    SELECT
        date,
        transaction_count,
        avg_spend,
        rain_flag,
        temp,
        rain,
        ROUND(AVG(transaction_count) OVER (
            ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ), 2) AS transaction_7day_avg
    FROM
        daily_stats
),
customer_segments AS (
    SELECT
        customer_id,
        SUM(amount) AS total_spent,
        COUNT(*) AS transaction_count,
        CASE
            WHEN SUM(amount) > 1000 THEN 'High Value'
            WHEN SUM(amount) BETWEEN 500 AND 1000 THEN 'Medium Value'
            ELSE 'Low Value'
        END AS segment
    FROM
        transactions
    GROUP BY
        customer_id
)
SELECT
    m.date,
    m.transaction_count,
    m.avg_spend,
    m.transaction_7day_avg,
    m.rain_flag,
    m.temp,
    m.rain,
    cs.segment,
    cs.total_spent
FROM
    moving_avg m
    JOIN transactions t ON CAST(m.date AS DATE) = CAST(t.date AS DATE)
    JOIN customer_segments cs ON t.customer_id = cs.customer_id
ORDER BY
    m.date DESC;
